# خلاصه رفع مشکلات افزونه Tabesh v2

## تاریخ: 2026-01-05

## مشکلات رفع شده:

### 1. پیکربندی سرویس ملی پیامک (Melipayamak OTP)

#### مشکل:
- پیکربندی اشتباه برای ارسال پیامک احراز هویت
- استفاده نادرست از پارامترها و متد API
- وجود فیلد "شماره ارسال کننده" که برای متد الگویی نیاز نیست

#### راه حل:
**فایل: `includes/helpers/class-melipayamak.php`**

1. **حذف فیلدهای غیرضروری:**
   - حذف `sender_number` (شماره فرستنده در تنظیمات الگو در پنل ملی پیامک تعریف می‌شود)
   - حذف `wsdl_url` (از REST API استفاده می‌شود نه SOAP)

2. **تنظیم صحیح API Endpoint:**
   ```
   قبل: https://rest.payamak-panel.com/api/SendSMS/SendByBaseNumber2
   بعد: https://rest.payamak-panel.com/api/SendSMS/BaseServiceNumber
   ```

3. **تنظیم صحیح پارامترها:**
   - نوع محتوا: `application/x-www-form-urlencoded` (به جای JSON)
   - پارامترهای الزامی:
     - `username`: نام کاربری پنل ملی پیامک
     - `password`: رمز عبور پنل ملی پیامک
     - `text`: کد OTP (متغیر الگو)
     - `to`: شماره موبایل گیرنده
     - `bodyId`: کد الگو (Pattern ID) - باید عدد صحیح باشد

4. **پردازش صحیح پاسخ API:**
   - بررسی فیلد `Value` در پاسخ
   - اگر `Value` بیشتر از 1000000000000 باشد = موفق (recId)
   - اگر `Value` منفی یا کمتر باشد = خطا

5. **بروزرسانی کدهای خطا:**
   کدهای خطا مطابق مستندات رسمی ملی پیامک به‌روزرسانی شدند:
   - `-111`: IP درخواست کننده نامعتبر است
   - `-110`: الزام استفاده از ApiKey
   - `-4`: کد متن ارسالی صحیح نیست
   - `0`: نام کاربری یا رمز عبور صحیح نیست
   - `2`: اعتبار کافی نیست
   - و سایر کدهای خطا...

**فایل: `assets/js/src/components/UserDashboardSettings.js`**

بهبود پیام اطلاعاتی:
- اضافه شدن توضیحات کامل درباره متد API
- نمایش آدرس endpoint مورد استفاده
- توضیح اینکه شماره فرستنده نیاز نیست

### 2. رفع مشکل بارگذاری استایل React در تنظیمات داشبورد

#### مشکل:
- استایل‌های React به صورت نامرتب و خراب لود می‌شدند
- فرم‌ها ساختار مشخصی نداشتند

#### راه حل:
**فایل: `assets/css/admin.css`**

1. **اضافه شدن استایل‌های جامع:**
   - استایل برای wrapper اصلی (`.tabesh-user-dashboard-panel`)
   - استایل برای container تنظیمات (`.tabesh-settings-container`)
   - استایل برای section عملیات (`.tabesh-settings-actions`)

2. **بهبود قابلیت استفاده:**
   - اضافه شدن `sticky positioning` برای دکمه ذخیره
   - بهبود layout و spacing
   - اضافه شدن shadow و transition effects

3. **پشتیبانی از پیام‌های چند خطی:**
   - بهبود استایل `.settings-notice` برای نمایش چند پاراگراف
   - افزودن line-height و margin مناسب

### 3. رفع مشکل نمایش محتوای React برای کاربران وارد شده

#### مشکل:
- کاربران وارد شده نمی‌توانستند محتوای React داشبورد را ببینند

#### راه حل:
**فایل: `includes/shortcodes/class-customer-dashboard-shortcode.php`**

حذف محدودیت‌های اضافی در enqueue کردن assets:
```php
// قبل:
if ( ! is_singular() && ! is_page() ) {
    return;
}

// بعد:
// Always enqueue when this method is called (shortcode is being used)
```

این تغییر تضمین می‌کند که وقتی shortcode استفاده می‌شود، assets همیشه لود شوند.

## نحوه استفاده از تنظیمات جدید:

### تنظیمات ملی پیامک:

1. وارد **داشبورد وردپرس** > **Tabesh v2** > **داشبورد کاربران** شوید
2. در بخش **"تنظیمات ملی پیامک"** موارد زیر را وارد کنید:
   - **نام کاربری**: نام کاربری پنل ملی پیامک خود
   - **رمز عبور**: رمز عبور پنل ملی پیامک خود
   - **کد پترن**: شناسه الگو (BodyId) که در پنل ملی پیامک ایجاد کرده‌اید

3. برای ایجاد الگو در پنل ملی پیامک:
   - وارد پنل شوید
   - بخش الگوها (Patterns) را باز کنید
   - الگوی جدید بسازید با متن مانند: "کد تایید شما: {code}"
   - کد الگو (BodyId) را در تنظیمات افزونه وارد کنید

4. روی دکمه **"ارسال پیامک آزمایشی"** کلیک کنید تا اتصال را تست کنید

### نمایش داشبورد کاربری:

داشبورد به صورت خودکار با shortcode `[tabesh_customer_dashboard]` نمایش داده می‌شود.

- کاربران **وارد نشده**: فرم ورود/ثبت نام با OTP را می‌بینند
- کاربران **وارد شده**: پنل کاربری کامل با منوها و بخش‌های مختلف را می‌بینند

## فایل‌های تغییر یافته:

1. `includes/helpers/class-melipayamak.php` - اصلاح API ملی پیامک
2. `includes/shortcodes/class-customer-dashboard-shortcode.php` - رفع مشکل asset loading
3. `assets/js/src/components/UserDashboardSettings.js` - بهبود رابط کاربری
4. `assets/css/admin.css` - اضافه شدن استایل‌های جدید

## تست و بررسی:

### چک لیست تست:

- [ ] تست ارسال پیامک OTP با شماره واقعی
- [ ] بررسی نمایش صحیح فرم ورود برای کاربران guest
- [ ] بررسی نمایش صحیح داشبورد برای کاربران لاگین شده
- [ ] تست استایل‌ها در صفحه تنظیمات ادمین
- [ ] تست دکمه ذخیره تنظیمات
- [ ] بررسی console browser برای خطاهای JavaScript

### نکات مهم:

1. **قبل از استفاده در production**، حتماً با یک شماره تست کنید
2. اعتبار کافی در پنل ملی پیامک داشته باشید
3. الگوی پیامک باید توسط مدیر سامانه تایید شده باشد
4. در صورت دریافت خطا، کد خطا را با مستندات بالا مقایسه کنید

## لینک‌های مفید:

- [مستندات رسمی API ملی پیامک](http://api.payamak-panel.com/)
- [راهنمای متد SendByBaseNumber2](http://api.payamak-panel.com/post/send.asmx)

## پشتیبانی:

در صورت بروز مشکل:
1. خطاهای console مرورگر را بررسی کنید
2. لاگ خطاهای PHP در وردپرس را چک کنید
3. تنظیمات API را دوباره بررسی کنید
4. با پشتیبانی ملی پیامک تماس بگیرید در صورت خطاهای مربوط به API
