(()=>{"use strict";const e=window.React,t=window.wp.element,a=window.wp.i18n,n=({phoneNumber:n,onVerified:s,onBack:r})=>{const[o,l]=(0,t.useState)(""),[m,i]=(0,t.useState)(""),[c,h]=(0,t.useState)(!1),[b,u]=(0,t.useState)(120),[d,p]=(0,t.useState)(!1);return(0,t.useEffect)(()=>{if(b>0){const e=setTimeout(()=>{u(b-1)},1e3);return()=>clearTimeout(e)}p(!0)},[b]),(0,e.createElement)("form",{onSubmit:async e=>{e.preventDefault(),i(""),h(!0);try{const e=await fetch(`${tabeshAuthData.apiUrl}/verify-otp`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":tabeshAuthData.nonce},body:JSON.stringify({phone_number:n,otp_code:o})}),t=await e.json();t.success?t.needs_registration?s(!0):s(!1):i(t.message||(0,a.__)("Invalid OTP code","tabesh-v2"))}catch(e){i((0,a.__)("Network error. Please try again.","tabesh-v2"))}finally{h(!1)}},className:"tabesh-auth-form"},(0,e.createElement)("div",{className:"tabesh-otp-info"},(0,e.createElement)("p",null,(0,a.__)("Enter the verification code sent to","tabesh-v2"),(0,e.createElement)("br",null),(0,e.createElement)("strong",{dir:"ltr"},n))),m&&(0,e.createElement)("div",{className:"tabesh-auth-error"},m),(0,e.createElement)("div",{className:"tabesh-form-group"},(0,e.createElement)("label",{htmlFor:"otp-code"},(0,a.__)("Verification Code","tabesh-v2")),(0,e.createElement)("input",{type:"text",id:"otp-code",value:o,onChange:e=>l(e.target.value.replace(/\D/g,"")),placeholder:"123456",required:!0,maxLength:"6",pattern:"\\d{6}",disabled:c,dir:"ltr",autoComplete:"off",autoFocus:!0})),(0,e.createElement)("button",{type:"submit",className:"tabesh-btn tabesh-btn-primary",disabled:c||6!==o.length},c?(0,a.__)("Verifying...","tabesh-v2"):(0,a.__)("Verify","tabesh-v2")),(0,e.createElement)("div",{className:"tabesh-auth-actions"},(0,e.createElement)("button",{type:"button",onClick:r,className:"tabesh-btn-link",disabled:c},(0,a.__)("Change phone number","tabesh-v2")),d?(0,e.createElement)("button",{type:"button",onClick:async()=>{if(d){i(""),h(!0),p(!1),u(120);try{const e=await fetch(`${tabeshAuthData.apiUrl}/request-otp`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":tabeshAuthData.nonce},body:JSON.stringify({phone_number:n})}),t=await e.json();t.success||(i(t.message||(0,a.__)("Failed to resend OTP","tabesh-v2")),p(!0),u(0))}catch(e){i((0,a.__)("Network error. Please try again.","tabesh-v2")),p(!0),u(0)}finally{h(!1)}}},className:"tabesh-btn-link",disabled:c},(0,a.__)("Resend code","tabesh-v2")):(0,e.createElement)("span",{className:"tabesh-timer"},(0,a.__)("Resend in","tabesh-v2")," ",(_=b,`${Math.floor(_/60)}:${(_%60).toString().padStart(2,"0")}`))));var _},s=({phoneNumber:n,onComplete:s,onBack:r})=>{const[o,l]=(0,t.useState)({firstName:"",lastName:"",companyName:""}),[m,i]=(0,t.useState)(""),[c,h]=(0,t.useState)(""),[b,u]=(0,t.useState)(!1),d=e=>{l({...o,[e.target.name]:e.target.value})};return(0,e.createElement)("form",{onSubmit:async e=>{e.preventDefault(),h(""),u(!0);try{const e=await fetch(`${tabeshAuthData.apiUrl}/complete-registration`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":tabeshAuthData.nonce},body:JSON.stringify({phone_number:n,otp_code:m,first_name:o.firstName,last_name:o.lastName,company_name:o.companyName})}),t=await e.json();t.success?s():h(t.message||(0,a.__)("Registration failed","tabesh-v2"))}catch(e){h((0,a.__)("Network error. Please try again.","tabesh-v2"))}finally{u(!1)}},className:"tabesh-auth-form"},(0,e.createElement)("div",{className:"tabesh-register-info"},(0,e.createElement)("p",null,(0,a.__)("Please complete your profile","tabesh-v2"))),c&&(0,e.createElement)("div",{className:"tabesh-auth-error"},c),(0,e.createElement)("div",{className:"tabesh-form-group"},(0,e.createElement)("label",{htmlFor:"otp-code"},(0,a.__)("Verification Code","tabesh-v2")),(0,e.createElement)("input",{type:"text",id:"otp-code",value:m,onChange:e=>i(e.target.value.replace(/\D/g,"")),placeholder:"123456",required:!0,maxLength:"6",pattern:"\\d{6}",disabled:b,dir:"ltr",autoComplete:"off"})),(0,e.createElement)("div",{className:"tabesh-form-group"},(0,e.createElement)("label",{htmlFor:"first-name"},(0,a.__)("First Name","tabesh-v2")," *"),(0,e.createElement)("input",{type:"text",id:"first-name",name:"firstName",value:o.firstName,onChange:d,required:!0,disabled:b})),(0,e.createElement)("div",{className:"tabesh-form-group"},(0,e.createElement)("label",{htmlFor:"last-name"},(0,a.__)("Last Name","tabesh-v2")," *"),(0,e.createElement)("input",{type:"text",id:"last-name",name:"lastName",value:o.lastName,onChange:d,required:!0,disabled:b})),(0,e.createElement)("div",{className:"tabesh-form-group"},(0,e.createElement)("label",{htmlFor:"company-name"},(0,a.__)("Company Name (Optional)","tabesh-v2")),(0,e.createElement)("input",{type:"text",id:"company-name",name:"companyName",value:o.companyName,onChange:d,disabled:b})),(0,e.createElement)("button",{type:"submit",className:"tabesh-btn tabesh-btn-primary",disabled:b||!o.firstName||!o.lastName||6!==m.length},b?(0,a.__)("Completing...","tabesh-v2"):(0,a.__)("Complete Registration","tabesh-v2")),(0,e.createElement)("div",{className:"tabesh-auth-actions"},(0,e.createElement)("button",{type:"button",onClick:r,className:"tabesh-btn-link",disabled:b},(0,a.__)("Back","tabesh-v2"))))},r=()=>{const[r,o]=(0,t.useState)("phone"),[l,m]=(0,t.useState)(""),[i,c]=(0,t.useState)(""),[h,b]=(0,t.useState)(!1);return(0,e.createElement)("div",{className:"tabesh-auth-container"},(0,e.createElement)("div",{className:"tabesh-auth-card"},(0,e.createElement)("div",{className:"tabesh-auth-header"},(0,e.createElement)("h1",null,(0,a.__)("Welcome to Tabesh","tabesh-v2")),(0,e.createElement)("p",null,(0,a.__)("Sign in with your phone number","tabesh-v2"))),i&&(0,e.createElement)("div",{className:"tabesh-auth-error"},i),"phone"===r&&(0,e.createElement)("form",{onSubmit:async e=>{e.preventDefault(),c(""),b(!0);try{const e=await fetch(`${tabeshAuthData.apiUrl}/request-otp`,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":tabeshAuthData.nonce},body:JSON.stringify({phone_number:l})}),t=await e.json();t.success?o("otp"):c(t.message||(0,a.__)("Failed to send OTP","tabesh-v2"))}catch(e){c((0,a.__)("Network error. Please try again.","tabesh-v2"))}finally{b(!1)}},className:"tabesh-auth-form"},(0,e.createElement)("div",{className:"tabesh-form-group"},(0,e.createElement)("label",{htmlFor:"phone-number"},(0,a.__)("Phone Number","tabesh-v2")),(0,e.createElement)("input",{type:"tel",id:"phone-number",value:l,onChange:e=>m(e.target.value),placeholder:"09123456789",required:!0,pattern:"^09\\d{9}$",title:(0,a.__)("Please enter a valid Iranian mobile number","tabesh-v2"),disabled:h,dir:"ltr"})),(0,e.createElement)("button",{type:"submit",className:"tabesh-btn tabesh-btn-primary",disabled:h},h?(0,a.__)("Sending...","tabesh-v2"):(0,a.__)("Send OTP","tabesh-v2"))),"otp"===r&&(0,e.createElement)(n,{phoneNumber:l,onVerified:e=>{e?o("register"):window.location.href=tabeshAuthData.redirectUrl},onBack:()=>o("phone")}),"register"===r&&(0,e.createElement)(s,{phoneNumber:l,onComplete:()=>{window.location.href=tabeshAuthData.redirectUrl},onBack:()=>o("otp")})))};function o(){const a=document.getElementById("tabesh-auth-root");a&&(0,t.createRoot)(a).render((0,e.createElement)(r,null))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",o):o()})();